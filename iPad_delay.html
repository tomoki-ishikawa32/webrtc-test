<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>iPad 映像受信</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: black;
    }
    #remoteVideo {
      width: 100vw;
      height: 100vh;
      object-fit: contain;
      background: black;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      background-color: rgba(255,255,255,0.8);
      padding: 10px;
      border-radius: 8px;
    }
    textarea {
      width: 90vw;
      max-width: 600px;
    }
  </style>
</head>
<body>
  <video id="remoteVideo" autoplay playsinline controls></video>

  <div id="controls">
    <h3>iPad 映像受信（5秒遅延）</h3>
    <textarea id="offer" placeholder="Paste Offer SDP here" rows="8"></textarea><br>
    <button id="setOffer">Set Offer</button>
    <br><br>
    <textarea id="answer" placeholder="Answer SDP" rows="8" readonly></textarea><br>
    <button id="goFullscreen">全画面表示</button>
  </div>

  <script>
    let pc;
    let buffer = [];
    let isPlaying = false;
    let recorder;
    const video = document.getElementById('remoteVideo');

    document.getElementById('setOffer').onclick = async () => {
      const offerSDP = JSON.parse(document.getElementById('offer').value);
      pc = new RTCPeerConnection();

      pc.ontrack = (event) => {
        const stream = event.streams[0];
        startBuffering(stream);
      };

      pc.onicecandidate = (event) => {
        if (event.candidate === null) {
          document.getElementById('answer').value = JSON.stringify(pc.localDescription);
        }
      };

      await pc.setRemoteDescription(new RTCSessionDescription(offerSDP));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
    };

    function startBuffering(stream) {
      recorder = new MediaRecorder(stream, { mimeType: "video/webm; codecs=vp9" });
      recorder.start(1000); // 1秒ごとに分割して保存

      recorder.ondataavailable = (e) => {
        buffer.push(e.data);
        if (!isPlaying && buffer.length >= 5) {
          isPlaying = true;
          playLoop(); // 遅延再生ループ開始
        }
      };
    }

    async function playLoop() {
      while (true) {
        if (buffer.length >= 5) {
          const chunk = buffer.splice(0, 5); // 5秒分取り出し
          const blob = new Blob(chunk, { type: "video/webm" });
          video.src = URL.createObjectURL(blob);
          await video.play();

          // 再生終了まで待つ
          await new Promise(resolve => video.onended = resolve);
        } else {
          // バッファが足りないときは少し待つ
          await new Promise(resolve => setTimeout(resolve, 500));
        }
      }
    }

    document.getElementById('goFullscreen').onclick = () => {
      if (video.requestFullscreen) {
        video.requestFullscreen();
      } else if (video.webkitRequestFullscreen) {
        video.webkitRequestFullscreen();
      } else if (video.msRequestFullscreen) {
        video.msRequestFullscreen();
      }
    };
  </script>
</body>
</html>
